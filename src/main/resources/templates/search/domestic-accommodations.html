<!DOCTYPE html>
<html lang="ko" layout:decorate="~{layout/main}"
      layout:fragment="main"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <link href="https://cdn.jsdelivr.net/npm/nouislider/dist/nouislider.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="/css/component/slider.css" rel="stylesheet">
    <style>
        /* 기존 스타일 유지 */
        .noUi-moving .noUi-touch-area {
            pointer-events: none;
        }

        .noUi-handle {
            pointer-events: all;
            z-index: 10;
        }

        @media (max-width: 768px) {
            /* General layout adjustments */
            .flex-row {
                flex-direction: column !important;
            }
            .mq1050\:hidden {
                display: block !important;
            }
            .max-w-full {
                max-width: 100% !important;
            }
            .px-\[20px\] {
                padding-left: 20px !important;
                padding-right: 20px !important;
            }

            /* Adjustments for the main filter */
            #main-filter {
                margin-top: 20px !important;
            }

            /* Adjustments for the card wrapper */
            #cardWrapperContainer > a {
                flex-direction: column !important;
            }
            #cardWrapperContainer > a > div {
                width: 100% !important;
                min-width: 100% !important;
            }

            /* Adjustments for the dropdown */
            .dropdown {
                width: 100% !important;
                margin-top: 10px !important;
            }

            /* Adjustments for the pagination */
            .pagination {
                flex-wrap: wrap !important;
                justify-content: center !important;
            }
            .pagination li {
                margin-bottom: 10px !important;
            }

            /* Additional mobile optimizations */
            .mq1050\:h-auto {
                height: auto !important;
            }
            .mq750\:pb-/[20px/] {
            padding-bottom: 20px !important;
        }
            .mq1050\:max-w-full {
                max-width: 100% !important;
            }
            .mq750\:flex-wrap {
                flex-wrap: wrap !important;
            }
            .mq450\:text-/[19px/] {
            font-size: 19px !important;
        }
            .mq750\:w-full {
                width: 100% !important;
            }
            .mq750\:h-/[9px/] {
            height: 9px !important;
        }
            .mq750\:flex-1 {
                flex: 1 1 0% !important;
            }
            .mq750\:min-w-full {
                min-width: 100% !important;
            }
            .mq750\:min-h-\[auto\] {
                min-height: auto !important;
            }
            .mq450\:flex-1 {
                flex: 1 1 0% !important;
            }
        }
    </style>
</head>
<body>
<div
        class="w-full relative bg-[#fff] flex flex-col items-start justify-start pt-[0px] px-[0px] pb-[100px] box-border leading-[normal] tracking-[normal]"
>
    <main
            class="self-stretch flex flex-row items-start justify-center py-[0px] px-[20px] box-border max-w-full"
    >
        <section
                class="w-[1200px] flex flex-row items-start justify-start pt-[16px] px-[0px] pb-[0px] box-border max-w-[1200px] text-left text-[15.1px] text-[#333] font-[Inter] lg:max-w-full mq1050:h-auto"
        >
            <div
                    class="flex-1 flex flex-row items-start justify-start gap-[16px] max-w-full shrink-0"
            >
                <div
                        class="w-[288px] flex flex-col items-start justify-start pt-[36px] px-[0px] pb-[0px] box-border mq1050:hidden"
                >
                    <div class="self-stretch flex flex-col items-start justify-start">
                        <div
                                class="self-stretch flex flex-row items-start justify-start pt-[0px] px-[0px] pb-[20px]"
                        >
                            <div
                                    class="flex-1 rounded-[12px] overflow-hidden flex flex-row items-start justify-start py-[66.4px] px-[80px] bg-[url('/image/domestic-accommodations/map@3x.png')] bg-cover bg-no-repeat bg-[top] mq450:pl-[20px] mq450:pr-[20px] mq450:box-border"
                            >
                                <button class="btn btn-primary w-32 h-[42px] flex flex-row items-center justify-center font-semibold text-[13.1px]  font-[Inter] text-[#fff] text-center"
                                        onclick="showMap()"
                                >
                                    지도 보기
                                </button>
                            </div>
                        </div>
                        <div id="main-filter" th:insert="~{component/search/searchfilter :: filterbar('main')}"></div>
                    </div>
                </div>
                <div
                        class="flex-1 flex flex-col items-start justify-start pt-[0px] pb-[104px] pl-[16px] pr-[0px] box-border max-w-[calc(100%_-_304px)] text-[10.3px] text-[#707070] lg:pb-[29px] lg:box-border mq750:pb-[20px] mq750:box-border mq1050:max-w-full"
                >
                    <div
                            class="self-stretch bg-[#fff] flex flex-row items-center justify-between pt-[16px] px-[0px] pb-[20px] box-border min-h-[80px] [row-gap:20px] max-w-full gap-[0px] text-[22.9px] text-[#333] mq1050:flex-wrap"
                    >
                        <div
                                class="w-[732px] flex flex-col items-start justify-start py-[0px] pl-[0px] pr-[16px] box-border max-w-full"
                        >
                            <div
                                    class="self-stretch overflow-hidden flex flex-row items-start justify-start py-[0px] pl-[0px] [row-gap:20px] mq450:pr-[20px] mq450:box-border mq750:flex-wrap mq750:pr-[267px] mq750:box-border"
                            >
                                <h3 class="m-[0px] w-max relative text-[24px] font-bold font-[inherit] flex items-center mq450:text-[19px] mq750:w-full mq750:h-[9px]">
                                    '<span id="keyword_value"></span>' 검색 결과&nbsp;
                                    <span th:text="${resultAccommodations.size()} + '개'"></span>
                                </h3>
                            </div>
                        </div>
                        <div
                                class="flex flex-col items-start justify-start text-[15px]"
                        >

                            <div class="dropdown pr-[9px] min-w-[41.48px]"
                                 id="sortTypeDropdown"
                            >
                                <button aria-expanded="false"
                                        class="btn btn-light dropdown-toggle w-[100%]"
                                        data-bs-toggle="dropdown" id="dropdown-sortType-button" type="button"
                                        value="rating">
                                    평점높은순
                                </button>
                                <ul class="dropdown-menu">
                                    <li data-value="rating"><p class="dropdown-item">평점높은순</p></li>
                                    <li data-value="review"><p class="dropdown-item">리뷰많은순</p></li>
                                    <li data-value="lowPrice"><p class="dropdown-item">낮은가격순</p></li>
                                    <li data-value="highPrice"><p class="dropdown-item">높은가격순</p></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div
                            class="self-stretch bg-[#fff] border-solid box-border flex flex-col items-start justify-start px-[0px] pb-[19px] max-w-full cursor-pointer"
                            id="cardWrapperContainer">
                        <a class="self-stretch flex flex-row items-start justify-start [row-gap:20px] max-w-full mq750:flex-wrap pt-6 pb-6 border-[#ebebeb] border-b-[1px]" id="card"
                           th:each="accommodation : ${resultAccommodations}"
                           th:href="@{'/search/detail-host?id=' + ${accommodation.HIdx}}"
                        >
                            <div
                                    class="h-[240px] w-[396px] flex flex-col items-start justify-center min-w-[396px] max-w-full mq750:flex-1 mq750:min-w-full"
                            >
                                <img
                                        alt="GCS 이미지"
                                        class="self-stretch flex-1 relative rounded-[12px] max-w-full overflow-hidden max-h-full object-cover mq750:self-stretch mq750:w-auto"
                                        loading="lazy"
                                        th:src="${accommodation.img_url}"
                                />
                            </div>
                            <div class="flex-1 overflow-hidden flex flex-col items-start justify-between py-[0px] pl-[20px] pr-[0px] box-border min-w-[315px] min-h-[240px] max-w-full mq750:min-h-[auto]"

                            >
                                <div
                                        class="self-stretch flex flex-col items-start justify-start pt-[0px] px-[0px] pb-[4px]"
                                >
                                    <div
                                            class="self-stretch flex flex-col items-start justify-start gap-[4px]"
                                    >
                                        <div
                                                class="self-stretch flex flex-col items-start justify-start gap-[2px]"
                                        >
                                            <div
                                                    class="self-stretch flex flex-row items-center justify-start"
                                            >
                                                <div
                                                        class="flex flex-row items-center justify-start"
                                                >
                                                    <div class="relative font-semibold inline-block min-w-[21px]"
                                                         th:text="${accommodation.HCate.getDescription()}"
                                                    >
                                                        펜션
                                                    </div>
                                                </div>
                                            </div>
                                            <div
                                                    class="self-stretch flex flex-col items-start justify-start text-[16.9px] text-[#333]"
                                            >
                                                <b class="self-stretch relative" th:text="${accommodation.HName}"
                                                >강릉 라임비치 스파 펜션</b
                                                >
                                            </div>
                                        </div>
                                        <div
                                                class="self-stretch flex flex-row items-center justify-start py-[0px] pl-[0px] pr-[361px] [row-gap:20px] text-[11.6px] text-[#333] mq450:pr-[180px] mq450:box-border mq750:flex-wrap"
                                        >
                                            <div
                                                    class="flex flex-col items-start justify-start py-[0px] pl-[0px] pr-[6px]"
                                            >
                                                <div
                                                        class="rounded-[6px] bg-[#ffad0a] flex flex-row items-center justify-center pt-[4px] pb-[3px] pl-[3px] pr-[5px]"
                                                >
                                                    <div
                                                            class="flex flex-col items-start justify-start pt-[0px] pb-[2px] pl-[0px] pr-[2px]"
                                                    >
                                                        <div
                                                                class="overflow-hidden flex flex-col items-center justify-center"
                                                        >
                                                            <img
                                                                    alt="img error"
                                                                    class="w-[12px] h-[12px] relative"
                                                                    src="/image/domestic-accommodations/frame.svg"
                                                            />
                                                        </div>
                                                    </div>
                                                    <div
                                                            class="flex flex-col items-start justify-start"
                                                    >
                                                        <b class="relative inline-block min-w-[19px]"
                                                           th:text="${accommodation.rating}"
                                                        >???</b
                                                        >
                                                    </div>
                                                </div>
                                            </div>
                                            <div
                                                    class="flex flex-col items-start justify-start text-[12.3px] text-[#707070] mq450:ml-[0px]"
                                            >
                                                <div class="relative font-medium inline-block min-w-[56px]"
                                                     th:text="${accommodation.reviewCount + '명 평가'}"
                                                >
                                                    ???
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div
                                        class="self-stretch flex flex-col items-start justify-start pt-[8px] pb-[0px] pl-[12px] pr-[0px] text-right text-[12.2px] text-[#999]"
                                >
                                    <div
                                            class="self-stretch flex flex-col items-end justify-start"
                                    >
                                        <div class="flex flex-col items-end justify-start">
                                            <div class="relative font-medium inline-block min-w-[74px] whitespace-nowrap"
                                                 th:if="${accommodation.oneDayPrice == null}">
                                                다른 날짜 확인
                                            </div>
                                            <div class="self-stretch flex flex-row items-end justify-start"
                                                 th:if="${accommodation.oneDayPrice}"
                                            >
                                                <b class="relative inline-block min-w-[80px] text-[19.2px] font-bold text-[#333]"
                                                   th:text="${accommodation.oneDayPrice}">
                                                    ???
                                                </b>
                                                <b class="relative inline-block min-w-[15px] text-[16px] font-bold text-[#333]">원</b>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div
                                class="self-stretch flex flex-row items-start justify-center pt-[40px] px-[20px] pb-[0px] text-center text-[12px] text-[#000]"
                        >
                            <div class="flex flex-col items-start justify-start">
                                <ul class="pagination" th:if="${pageNation.totalElements > 0}">
                                    <!-- Previous 페이지 링크 -->
                                    <li class="page-item" th:classappend="${pageNation.pageNumber == 0} ? 'disabled'">
                                        <a aria-label="Previous" class="page-link"
                                           th:onclick="${pageNation.pageNumber > 0} ? 'performSearch(\'main\', ' + ${pageNation.pageNumber} + ')' : ''">
                                            Previous
                                        </a>
                                    </li>

                                    <!-- 페이지 숫자 링크들 -->
                                    <li class="page-item"
                                        th:classappend="${pageNum == (pageNation.pageNumber + 1)} ? 'active'"
                                        th:each="pageNum : ${#numbers.sequence(1, pageNation.totalPages)}">
                                        <a class="page-link" th:onclick="'performSearch(\'main\', ' + ${pageNum} + ')'"
                                           th:text="${pageNum}">
                                        </a>
                                    </li>

                                    <!-- 다음 페이지 링크 -->
                                    <li class="page-item"
                                        th:classappend="${pageNation.pageNumber == (pageNation.totalPages - 1)} ? 'disabled'">
                                        <a aria-label="Next" class="page-link"
                                           th:onclick="${pageNation.pageNumber < (pageNation.totalPages - 1)} ? 'performSearch(\'main\', ' + (${pageNation.pageNumber} + 2) + ')' : ''">
                                            Next
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>
<div class="h-full w-full fixed top-0 left-0 items-center justify-center bg-gray-800 bg-opacity-50 hidden z-50"
     id="modal-wrap">
    <div class="bg-white w-[90%] h-[90%]" id="modal" th:include="~{/search/modal :: search_modal}"
         th:with="accommodations=${resultAccommodationsMap}"></div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8dd30de44c81fc848e5a3aa06bcdd212" type="text/javascript"></script>
<script type="text/template" id="accommodationModal-template">
    <div id="modalCard${hidx}" class="self-stretch bg-[#fff] overflow-hidden flex flex-row items-start justify-start py-[20px] px-[0px] [row-gap:20px] mq450:flex-wrap border-b-2 border-[#ebebeb]">
        <img class="self-stretch w-[115px] relative max-h-full object-cover min-h-[172px] mq450:flex-1"
             loading="lazy" alt="" src="${img_url}" />

        <div class="flex-1 overflow-hidden flex flex-col items-start justify-start gap-[86px] min-w-[146px]">
            <div class="self-stretch flex flex-row items-start justify-start py-[0px] pl-[20px] pr-[0px]">
                <div class="flex-1 flex flex-col items-start justify-start pt-[0px] px-[0px] pb-[4px] mq450:flex-1">
                    <div class="self-stretch flex flex-col items-start justify-start gap-[4px]">
                        <div class="self-stretch flex flex-col items-start justify-start gap-[2px]">
                            <div class="self-stretch flex flex-row items-center justify-start">
                                <div class="flex flex-row items-center justify-start py-[0px] pl-[0px] pr-[20px]">
                                    <div class="relative leading-[12.67px] font-semibold inline-block min-w-[21px]">${HCate}</div>
                                </div>
                            </div>
                            <div class="self-stretch flex flex-col items-start justify-start text-[16.9px] text-[#333]">
                                <b class="self-stretch relative">${HName}</b>
                            </div>
                        </div>
                        <div class="self-stretch flex flex-row items-center justify-start py-[0px] pl-[0px] pr-[102px] text-[11.6px] text-[#333]">
                            <div class="flex flex-col items-start justify-start py-[0px] pl-[0px] pr-[6px]">
                                <div class="rounded-[6px] bg-[#ffad0a] flex flex-row items-center justify-center pt-[4px] pb-[3px] pl-[3px] pr-[5px]">
                                    <div class="flex flex-col items-start justify-start pt-[0px] pb-[2px] pl-[0px] w-3 h-3">
                                        <img class="w-full h-full relative" loading="lazy" alt="" src="/image/domestic-accommodations/frame.svg" />
                                    </div>
                                    <div class="flex flex-col items-start justify-start">
                                        <b class="relative inline-block min-w-[19px]">${rating}</b>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-start justify-start text-[12.3px] text-[#707070]">
                                <div class="relative font-medium inline-block min-w-[56px]">${reviewCount}명 평가</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="self-stretch flex flex-col items-start justify-start pt-[8px] pb-[0px] pl-[12px] pr-[20px] text-right text-[12.2px] text-[#999]">
                <div class="self-stretch flex flex-col items-end justify-start">
                    <div class="flex flex-col items-start justify-start">
                        <div class="flex flex-col items-end justify-start">
                            <div class="relative font-medium inline-block min-w-[74px] whitespace-nowrap" th:if="${soldOut}">다른 날짜 확인</div>
                            <div class="self-stretch flex flex-row items-end justify-start" th:unless="${soldOut}">
                                <b class="relative inline-block min-w-[80px] text-[16px] font-bold text-[#333]">${oneDayPrice}</b>
                                <b class="relative inline-block min-w-[15px] text-[16px] font-bold text-[#333]">원</b>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>
<script th:inline="javascript">
    let hCate;
    let f_idx = [];
    let resultAccommodations;

    // URL 변수
    let sortTypeValue = null;
    let facilitiesValue = [];
    let hCateValue = null;
    let startPriceValue = null;
    let endPriceValue = null;
    let keywordValue = null;

    let sliderValues = {
        start: 0,
        end: 500000
    };

    $(document).ready(function () {
        resultAccommodations = /*[[${resultAccommodationsMap}]]*/ '[]';
        pageNation = /*[[${pageNation}]]*/ '{}';

        // URL에서 필터 값을 받아오기
        sortTypeValue = getUrlParameter('sortType');
        facilitiesValue = getUrlParameter('facilities');
        hCateValue = getUrlParameter('hCate');
        startPriceValue = getUrlParameter('startPrice');
        endPriceValue = getUrlParameter('endPrice');
        keywordValue = getUrlParameter('keyword');


        console.log(sortTypeValue + " sortTypeValue");
        console.log(facilitiesValue + " facilitiesValue");
        console.log(hCateValue + " hCateValue");
        console.log(startPriceValue + " startPriceValue");
        console.log(endPriceValue + " endPriceValue");

        initializeSlider('main');  // 메인 슬라이더 초기화

        let s_count = sessionStorage.getItem('count');
        if (s_count) {
            $("#person_count2").val(s_count);
        }

        // 드롭다운 메뉴 클릭 핸들러
        $('#sortTypeDropdown .dropdown-item').on('click', function () {
            let selectedText = $(this).text();
            let selectedValue = $(this).closest('li').data('value'); // 'data-value' 속성을 가져옴

            $('#dropdown-sortType-button').text(selectedText);
            $('#dropdown-sortType-button').val(selectedValue);

            performSearch('main');
        });

        // 시설 필터 버튼 클릭 이벤트 핸들러
        const btns = document.querySelectorAll('[id^="f_idx"]');
        console.log(btns + " btns");
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.classList.contains('bg-gray-300')) {
                    btn.classList.remove('bg-gray-300');
                    btn.classList.remove('f_idx');
                } else {
                    btn.classList.add('bg-gray-300');
                    btn.classList.add('f_idx');
                }
            });
        });

        $("#keyword_value").text(getUrlParameter('keyword'));

        setSortType(sortTypeValue);
        setFacilities(facilitiesValue, "main");
        setHCate(hCateValue, "main");

        //card 클릭시 url 이동
        let checkIn = sessionStorage.getItem('startDate');
        let checkOut = sessionStorage.getItem('endDate');
        let person = sessionStorage.getItem('people');
        $('#card').attr('href', function (i, href) {
            return href + '&checkIn=' + checkIn + '&checkOut=' + checkOut + '&person=' + person;
        });
    });

    // 필터 버튼 셋팅하는 함수
    // 필터 버튼 셋팅하는 함수
    function setSortType(sortTypeValue = null) {
        console.log(sortTypeValue + " sortTypeValue");
        let filterButton = $("#dropdown-sortType-button");

        if (sortTypeValue) {
            let filterText = $('#sortTypeDropdown li[data-value="' + sortTypeValue + '"] .dropdown-item').text();
            console.log(filterText + " filterText");
            filterButton.text(filterText);
            filterButton.val(sortTypeValue); // 여기서 sortTypeValue를 사용합니다.
        } else {
            filterButton.text("평점높은순");
            filterButton.val("rating");
        }
    }


    // 시설 필터 셋팅하는 함수
    function setFacilities(value = [], identifier = "") {
        console.log(value + " value");
        if (value !== null) {
            let facilities = value.split(',');
            facilities.forEach(facility => {
                let btn = $('#f_idx' + facility + '-' + identifier);
                btn.addClass('bg-gray-300');
                btn.addClass('f_idx');
            });
        }
    }

    function setHCate(hCate = null, identifier = "") {
        console.log(hCate + " hCate");

        // name이 'hCate'인 모든 input 요소 중에서 id가 identifier를 포함하는 요소 선택
        let radioButtons = document.querySelectorAll('input[name="hCate"][id*="' + identifier + '"]');
        console.log(radioButtons.values() + " radioButtons");
        radioButtons.forEach(function (radioButton) {
            console.log(radioButton.value + " radioButton.value");
            if (hCate !== null && hCate !== "") {
                if (radioButton.value === hCate) {
                    radioButton.checked = true;
                }
            } else {
                if (radioButton.value === 'all') {
                    radioButton.checked = true;
                }
            }
        });
    }

    // 필터 값을 가져오는 함수
    function getSortType() {
        let filterButton = document.getElementById('dropdown-sortType-button');
        if (filterButton) {
            return filterButton.value;
        } else {
            console.error('Dropdown filter button not found');
            return null;
        }
    }

    // 선택된 카테고리 값을 가져오는 함수
    function getHCate(identifier = "") {
        const selectedHCate = document.querySelector('input[name="hCate"]:checked');
        if (selectedHCate && selectedHCate.value === 'all') {
            return null;
        }
        return selectedHCate ? selectedHCate.value : null;
    }

    // 선택된 시설 값을 가져오는 함수
    function getSelectedFacilities(identifier = "") {
        const selectedBtns = document.querySelectorAll('.f_idx[id*="' + identifier + '"]');
        return Array.from(selectedBtns).map(btn => btn.value);
    }

    // URL 파라미터 값을 가져오는 함수
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        let regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        let results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    function synchronizeSliders(targetSlider) {
        if (targetSlider && targetSlider.noUiSlider) {
            let mainStart = document.getElementById('slider-start-main').value;
            let mainEnd = document.getElementById('slider-end-main').value;
            targetSlider.noUiSlider.set([mainStart, mainEnd]);
        }
    }

    // 슬라이더 초기화 함수
    function initializeSlider(identifier) {
        let sliderElement = document.getElementById('slider-' + identifier);
        let valueElement = document.getElementById('price-range-value-' + identifier);
        let startInput = document.getElementById('slider-start-' + identifier);
        let endInput = document.getElementById('slider-end-' + identifier);

        // 필수 요소 확인
        if (!sliderElement || !valueElement || !startInput || !endInput) {
            console.error('One of the required elements is missing for identifier:', identifier);
            return;
        }

        const startPrice = getUrlParameter('startPrice') ? parseInt(getUrlParameter('startPrice')) : 0;
        const endPrice = getUrlParameter('endPrice') ? parseInt(getUrlParameter('endPrice')) : 500000;

        // 공통된 슬라이더 값 객체
        const sliderValues = {
            start: startPrice,
            end: endPrice
        };

        // 슬라이더 초기화
        noUiSlider.create(sliderElement, {
            start: [sliderValues.start, sliderValues.end],
            connect: true,
            range: {
                'min': 0,
                '20%': 100000,
                '40%': 200000,
                '60%': 300000,
                '80%': 400000,
                'max': 500000
            },
            margin: 100000, // 두 핸들 간 최소 간격 설정
            snap: true // 스냅 기능 활성화
        });

        // 슬라이더 업데이트 핸들러
        sliderElement.noUiSlider.on('update', function (values) {
            sliderValues.start = parseInt(values[0]);
            sliderValues.end = parseInt(values[1]);

            if (sliderValues.end === 500000) {
                valueElement.innerText = sliderValues.start + '원 - ' + '500,000원 이상';
            } else {
                valueElement.innerText = sliderValues.start + '원 - ' + sliderValues.end + '원 미만';
            }

            startInput.value = sliderValues.start;
            endInput.value = sliderValues.end;
        });

        // 슬라이더 슬라이드 핸들러
        sliderElement.noUiSlider.on('slide', function (values, handle) {
            let start = parseInt(values[0]);
            let end = parseInt(values[1]);

            if (end - start < 30000) {
                if (handle === 0) {
                    sliderElement.noUiSlider.set([end - 30000, null]); // 왼쪽 핸들 값 조정
                } else {
                    sliderElement.noUiSlider.set([null, start + 30000]); // 오른쪽 핸들 값 조정
                }
            }
        });

        // 슬라이더 시작 핸들러
        sliderElement.noUiSlider.on('start', function () {
            sliderElement.classList.add('noUi-moving'); // 드래그 할 때 클래스 추가
        });

        // 슬라이더 종료 핸들러
        sliderElement.noUiSlider.on('end', function () {
            sliderElement.classList.remove('noUi-moving'); // 드래그 종료 시 클래스 제거
        });

        sliderElement.noUiSlider.on('set', function (values) {
            sliderValues.start = parseInt(values[0]);
            sliderValues.end = parseInt(values[1]);

            performSearch(identifier);

            if (identifier === 'main') {
                let modalSlider = document.getElementById('slider-modal');
                synchronizeSliders(modalSlider); // 모달 슬라이더 동기화
            }
        });

        // 메인 슬라이더에서 모달 슬라이더 동기화 시 모달 슬라이더도 performSearch 호출
        if (identifier === 'modal') {
            sliderElement.noUiSlider.on('set', function (values) {
                performSearch('modal');
            });
        }
    }

    // 모달 창 열기
    // 모달 창 열기
    function showMap() {
        $("#modal-wrap").css("display", "flex");
        $("body").css("overflow", "hidden");

        loadKaKaoMap(resultAccommodations);

        setFacilities(facilitiesValue, "modal");
        setHCate(hCateValue, "modal");

        document.getElementById('keyword_value_modal').innerText = "'" + keywordValue + "' 숙소 검색 결과";

        // 메인 슬라이더 값 가져오기
        let mainStart = parseInt(document.getElementById('slider-start-main').value) || 0;
        let mainEnd = parseInt(document.getElementById('slider-end-main').value) || 500000;

        // 모달 슬라이더 초기화 및 값 동기화
        destroySlider('modal');
        initializeSliderWithValues('modal', mainStart, mainEnd);
    }

    // 슬라이더 초기화 해제 함수
    function destroySlider(identifier) {
        let sliderElement = document.getElementById('slider-' + identifier);

        if (sliderElement && sliderElement.noUiSlider) {
            sliderElement.noUiSlider.destroy();
            console.log('Slider destroyed for identifier:', identifier);
        }
    }

    // 값으로 슬라이더 초기화 함수
    // 값으로 슬라이더 초기화 함수
    function initializeSliderWithValues(identifier, startValue, endValue) {
        let sliderElement = document.getElementById('slider-' + identifier);
        let valueElement = document.getElementById('price-range-value-' + identifier);
        let startInput = document.getElementById('slider-start-' + identifier);
        let endInput = document.getElementById('slider-end-' + identifier);

        // 필수 요소 확인
        if (!sliderElement || !valueElement || !startInput || !endInput) {
            console.error('One of the required elements is missing for identifier:', identifier);
            return;
        }

        // 반드시 슬라이더 제거 후 재초기화
        if (sliderElement.noUiSlider) {
            sliderElement.noUiSlider.destroy();
        }

        noUiSlider.create(sliderElement, {
            start: [startValue, endValue],
            connect: true,
            range: {
                'min': 0,
                '20%': 100000,
                '40%': 200000,
                '60%': 300000,
                '80%': 400000,
                'max': 500000
            },
            margin: 100000, // 두 핸들 간 최소 간격 설정
            snap: true // 스냅 기능 활성화
        });

        // 슬라이더 업데이트 핸들러
        sliderElement.noUiSlider.on('update', function (values) {
            let start = parseInt(values[0]);
            let end = parseInt(values[1]);

            if (end === 500000) {
                valueElement.innerText = start + '원 - ' + '500,000원 이상';
            } else {
                valueElement.innerText = start + '원 - ' + end + '원 미만';
            }

            startInput.value = start;
            endInput.value = end;
        });

        // 슬라이더 set 핸들러
        sliderElement.noUiSlider.on('set', function (values) {
            let start = parseInt(values[0]);
            let end = parseInt(values[1]);

            // 슬라이더 값 업데이트 후 검색 실행
            performSearch(identifier);

            // 메인 슬라이더와 동기화
            if (identifier === 'main') {
                synchronizeSliders(document.getElementById('slider-modal'));
            }

            if (identifier === 'modal') {
                performSearch('modal');
            }
        });
    }

    // 모달 창 닫기
    $("#modal_close").click(function () {
        $("#modal-wrap").css("display", "none");
        $("body").css("overflow", "auto");

        setSortType(sortTypeValue);
        setFacilities(facilitiesValue, "main");
        setHCate(hCateValue, "main");
    });

    // 검색 실행 함수
    function debouncedPerformSearch(identifier, page = 1) {
        // 동적으로 가져온 값을 사용
        const facilities = getSelectedFacilities(identifier);
        console.log(facilities);
        let hCate = getHCate(identifier);
        let startPrice = $('#slider-start-' + identifier).val();
        let endPrice = $('#slider-end-' + identifier).val();
        let keyword = sessionStorage.getItem('keyword');
        let startDay = sessionStorage.getItem('startDate');
        let endDay = sessionStorage.getItem('endDate');
        const person = sessionStorage.getItem('people');
        const sortType = getSortType(identifier)
        console.log(facilities
            + " facilities"
            + hCate
            + " hCate"
            + startPrice
            + " startPrice"
            + endPrice
            + " endPrice"
            + keyword
            + " keyword"
            + startDay
            + " startDay"
            + endDay
            + " endDay"
            + person
            + " person"
            + sortType
            + " sortType");
        if (identifier === "main") {
            console.log("page: ", page);

            // Query String 구성
            let queryString = '?';

            if (keyword) {
                queryString += `keyword=${encodeURIComponent(keyword)}&`;
            }
            if (startDay) {
                queryString += `checkIn=${encodeURIComponent(startDay)}&`;
            }
            if (endDay) {
                queryString += `checkOut=${encodeURIComponent(endDay)}&`;
            }
            if (person) {
                queryString += `person=${encodeURIComponent(person)}&`;
            }
            if (hCate) {
                queryString += `hCate=${encodeURIComponent(hCate)}&`;
            }
            if (facilities && facilities.length > 0) {
                queryString += `facilities=${encodeURIComponent(facilities.join(','))}&`;
            }
            if (startPrice) {
                queryString += `startPrice=${encodeURIComponent(startPrice)}&`;
            }
            if (endPrice) {
                queryString += `endPrice=${encodeURIComponent(endPrice)}&`;
            }
            if (sortType) {
                queryString += `sortType=${encodeURIComponent(sortType)}&`;
            }
            if (page && page > 1) {
                queryString += `page=${encodeURIComponent(page)}&`;
            }

            // 끝에 붙은 &를 제거
            if (queryString.endsWith('&')) {
                queryString = queryString.slice(0, -1);
            }

            console.log(queryString);

            // URL 변경 및 페이지 리로드
            window.location.href = `/search/domestic-accommodations${queryString}`;
        }  else if (identifier === "modal") {
            $.ajax({
                url: "/search/domestic-accommodations",
                type: "POST",
                data: {
                    facilities: facilities,
                    hCate: hCate,
                    startPrice: startPrice,
                    endPrice: endPrice,
                    keyword: keyword,
                    checkIn: startDay,
                    checkOut: endDay,
                    person: person,
                    sortType: sortType,
                    page: page
                }
            }).done(function (data) {
                console.log(data);

                // Kakao Map 로드
                loadKaKaoMap(data.resultAccommodationsMap);

                // 기존 컨텐츠를 지움
                $('#accommodationModal-container').empty();

                // 데이터를 템플릿에 적용
                data.resultAccommodationsMap.forEach(function (accommodation) {
                    let priceInfo = accommodation.oneDayPrice ? `${accommodation.oneDayPrice}원` : '다른 날짜 확인';
                    const template = $('#accommodationModal-template').html();
                    const rendered = template
                        .replace('${hidx}', accommodation.hidx)
                        .replace('${img_url}', accommodation.img_url)
                        .replace('${HCate}', accommodation.hcateKo) // .getDescription() 필요 없음
                        .replace('${HName}', accommodation.hname)
                        .replace('${rating}', accommodation.rating.toFixed(1))
                        .replace('${reviewCount}', accommodation.reviewCount)
                        .replace('${oneDayPrice}', priceInfo)

                        // 조건부 렌더링을 위해 ${soldOut}을 체크하여 대체
                        .replace('${soldOut}', accommodation.soldOut ? '다른 날짜 확인' : `<div class="self-stretch flex flex-row items-end justify-start"><b class="relative inline-block min-w-[80px] text-[16px] font-bold text-[#333]">${accommodation.oneDayPrice}</b><b class="relative inline-block min-w-[15px] text-[16px] font-bold text-[#333]">원</b></div>`);

                    $('#accommodationModal-container').append(rendered);
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                console.error("Error occurred during AJAX request:", textStatus, errorThrown);
            });
        }
    }

    // 검색 실행 함수를 지연시키는 함수
    const performSearch = debounce(debouncedPerformSearch, 300);

    //동작 지연시키기
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }


    // 카카오맵 로드
    function loadKaKaoMap(resultAccommodations) {
        initKaKaoMap();
        addMarkersTooMuch(resultAccommodations);
    }

    let map;
    let markers = [];
    let clickedMarkerId = null; // 클릭된 마커 ID 보관 변수

    function initKaKaoMap() {
        let container = document.getElementById('map');
        let options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 7
        };
        map = new kakao.maps.Map(container, options);
    }

    function addMarkersTooMuch(resultAccommodations) {
        removeMarkers(); // 이전의 마커를 제거합니다.

        let bounds = new kakao.maps.LatLngBounds();

        resultAccommodations.forEach((accommodation) => {
            let position = new kakao.maps.LatLng(parseFloat(accommodation.yaxis), parseFloat(accommodation.xaxis));
            bounds.extend(position);

            let priceInfo = accommodation.oneDayPrice ? `${accommodation.oneDayPrice}원` : '다른 날짜 확인';

            // 커스텀 마커 HTML 문자열
            let markerContent = `
        <div id="marker-wrapper-${accommodation.hidx}" class="group relative flex justify-center items-center custom-marker">
            <span id="marker-${accommodation.hidx}" class="balloon block max-w-xs bg-gray-400 group-hover:bg-gray-600 text-white rounded p-2 text-center transition-colors">
                ${priceInfo}
            </span>
            <div class="custom-arrow absolute bottom-[-8px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-t-8 border-t-gray-400 group-hover:border-t-gray-600 border-r-8 border-r-transparent border-l-8 border-l-transparent transition-colors"></div>
        </div>
        `;

            // 커스텀 인포 윈도우 내용 생성
            let infowindowContent = document.createElement('a');
            infowindowContent.className = 'bg-[#fff] overflow-hidden flex flex-row items-start justify-start w-[324px] h-[173px] p-[14px] box-border rounded-[20px] shadow-lg';
            infowindowContent.id = `infowindow-${accommodation.hidx}`;
            infowindowContent.href = `/search/detail-host?id=${accommodation.hidx}&checkIn=${sessionStorage.getItem('startDate')}&checkOut=${sessionStorage.getItem('endDate')}&person=${sessionStorage.getItem('people')}`;

            infowindowContent.innerHTML = `
        <img class="self-stretch w-[116px] relative h-full object-cover rounded-[20px]" loading="lazy" alt="" src="${accommodation.img_url}"/>
        <div class="flex-1 overflow-hidden flex flex-col items-start justify-start gap-[35px] h-[146px]">
            <div class="self-stretch flex flex-row items-start justify-start pt-[5px] pl-[20px] pr-[0px]">
                <div class="flex-1 flex flex-col items-start justify-start pt-[0px] px-[0px] pb-[4px] mq450:flex-1">
                    <div class="self-stretch flex flex-col items-start justify-start gap-[4px]">
                        <div class="self-stretch flex flex-col items-start justify-start gap-[2px]">
                            <div class="self-stretch flex flex-row items-center justify-start">
                                <div class="flex flex-row items-center justify-start py-[0px] pl-[0px] pr-[20px]">
                                    <div class="relative leading-[12.67px] font-semibold inline-block min-w-[21px] text-[#999]">
                                        ${accommodation.hcateKo}
                                    </div>
                                </div>
                            </div>
                            <div class="self-stretch flex flex-col items-start justify-start text-[16.9px] text-[#333]">
                                <b class="self-stretch relative">${accommodation.hname}</b>
                            </div>
                        </div>
                        <div class="self-stretch flex flex-row items-center justify-start py-[0px] pl-[0px] pr-[102px] text-[11.6px] text-[#333]">
                            <div class="flex flex-col items-start justify-start py-[0px] pl-[0px] pr-[6px]">
                                <div class="rounded-[6px] bg-[#ffad0a] flex flex-row items-center justify-center pt-[4px] pb-[3px] pl-[3px] pr-[5px]">
                                    <div class="flex flex-col items-start justify-start pt-[0px] pb-[2px] pl-[0px] w-3 h-3">
                                        <img class="w-full h-full relative" loading="lazy" alt="" src="/image/domestic-accommodations/frame.svg"/>
                                    </div>
                                    <div class="flex flex-col items-start justify-start">
                                        <b class="relative inline-block min-w-[19px]">${accommodation.rating.toFixed(1)}</b>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-start justify-start text-[12.3px] text-[#707070]">
                                <div class="relative font-medium inline-block min-w-[56px]">${accommodation.reviewCount}명 평가</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="self-stretch flex flex-col items-start justify-start pt-[8px] pb-[0px] pl-[12px] pr-[20px] text-right text-black">
                <div class="self-stretch flex flex-col items-end justify-start">
                    <div class="flex flex-col items-start justify-start">
                        <div class="flex flex-col items-end justify-start">
                            <div class="relative font-medium inline-block min-w-[74px] whitespace-nowrap text-base font-bold ">
                                ${priceInfo}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;


            let marker = new kakao.maps.CustomOverlay({
                position: position,
                content: markerContent,
                yAnchor: 1.2
            });

            let infowindow = new kakao.maps.CustomOverlay({
                position: position,
                content: infowindowContent,
                yAnchor: 0,
                zIndex: 50,
                map: null // 처음엔 보이지 않도록 설정
            });

            marker.setMap(map);

            // setTimeout을 사용하여 DOM이 완전히 로드된 후 이벤트 리스너 추가
            setTimeout(() => {
                let markerElement = document.getElementById(`marker-${accommodation.hidx}`);
                let markerWrapperElement = document.getElementById(`marker-wrapper-${accommodation.hidx}`);
                if (markerElement) {
                    let isMouseOver = false;  // 마우스 오버 상태 플래그
                    let isClicked = false;    // 클릭 상태 플래그

                    // 마우스 오버 이벤트 리스너 추가
                    markerWrapperElement.addEventListener('mouseover', function () {
                        isMouseOver = true;  // 마우스 오버 상태로 변경
                        if (!isClicked) {    // 클릭 상태가 아닌 경우에만 인포윈도우 표시
                            infowindow.setMap(map);
                        }
                    });

                    // 마우스 아웃 이벤트 리스너 추가
                    markerWrapperElement.addEventListener('mouseout', function () {
                        isMouseOver = false;  // 마우스 오버 상태 해제
                        if (!isClicked) {     // 클릭 상태가 아닌 경우에만 인포윈도우 숨김
                            infowindow.setMap(null);
                        }
                    });

                    // 클릭 이벤트 리스너 추가: 클릭된 마커에 대한 유지 및 스타일 설정은 동일하게 유지
                    markerElement.addEventListener('click', function () {
                        // 이전 클릭된 마커의 인포윈도우를 닫고 스타일 복구
                        if (clickedMarkerId !== null) {
                            let prevMarkerElement = document.getElementById(`marker-${clickedMarkerId}`);
                            let prevMarkerWrapperElement = document.getElementById(`marker-wrapper-${clickedMarkerId}`);
                            if (prevMarkerElement) {
                                prevMarkerElement.classList.remove('bg-black'); // 이전 클릭된 상태 색상 제거
                                prevMarkerWrapperElement.querySelector(".custom-arrow").classList.remove('border-t-black');
                                prevMarkerElement.classList.add('bg-gray-400'); // 원래 색상 복구
                            }
                            if (prevInfoWindow) {
                                prevInfoWindow.setMap(null);
                            }
                        }

                        if (clickedMarkerId !== accommodation.hidx) {
                            clickedMarkerId = accommodation.hidx;
                            prevInfoWindow = infowindow;
                            isClicked = true;  // 클릭 상태로 변경
                            markerElement.classList.remove('bg-gray-400'); // 클릭될 때 원래 색상 제거
                            markerElement.classList.add('bg-black'); // 클릭된 상태 색상 추가
                            markerWrapperElement.querySelector(".custom-arrow").classList.add('border-t-black');
                            infowindow.setMap(map);
                        } else {
                            clickedMarkerId = null;
                            prevInfoWindow = null;
                            isClicked = false; // 클릭 상태 해제
                            infowindow.setMap(null);
                        }
                    });

                    // 인포윈도우 닫기 버튼 이벤트 등록
                    let closeBtn = infowindowContent.querySelector('.close-btn');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', function () {
                            infowindow.setMap(null);
                            markerElement.classList.remove('bg-black'); // 클릭된 상태 색상 제거
                            markerWrapperElement.querySelector(".custom-arrow").classList.remove('border-t-black');
                            markerElement.classList.add('bg-gray-400'); // 원래 색상 복구
                            clickedMarkerId = null;
                            prevInfoWindow = null;
                            isClicked = false; // 클릭 상태 해제
                        });
                    }
                }
            }, 100);

            markers.push(marker);
        });

        map.setBounds(bounds);
    }

    function handleAccommodationClick(hidx) {
        console.log(hidx);
        if (!map) {
            console.error("Map 객체가 초기화되지 않았습니다.");
            return;
        }

        let marker = markers[hidx];
        let infowindow = infowindows[hidx];
        if (marker && infowindow) {
            // 이전 마커 및 인포윈도우 닫기
            if (clickedMarkerId !== null) {
                let prevMarkerElement = document.getElementById(`marker-${clickedMarkerId}`);
                let prevMarkerWrapperElement = document.getElementById(`marker-wrapper-${clickedMarkerId}`);
                if (prevMarkerElement) {
                    prevMarkerElement.classList.remove('bg-black');
                    prevMarkerWrapperElement.querySelector(".custom-arrow").classList.remove('border-t-black');
                    prevMarkerElement.classList.add('bg-gray-400');
                }
                if (prevInfoWindow) prevInfoWindow.setMap(null);
            }

            // 클릭된 마커 및 인포윈도우 열기
            if (clickedMarkerId !== hidx) {
                clickedMarkerId = hidx;
                prevInfoWindow = infowindow;
                let markerElement = document.getElementById(`marker-${hidx}`);
                let markerWrapperElement = document.getElementById(`marker-wrapper-${hidx}`);
                markerElement.classList.remove('bg-gray-400');
                markerElement.classList.add('bg-black');
                markerWrapperElement.querySelector(".custom-arrow").classList.add('border-t-black');
                infowindow.setMap(map);
                map.panTo(marker.getPosition());
            } else {
                clickedMarkerId = null;
                prevInfoWindow = null;
            }
        } else {
            console.warn(`Marker or Infowindow for hidx ${hidx}가 존재하지 않습니다.`);
        }
    }

    // 마커를 제거하는 함수
    function removeMarkers() {
        for (let i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
    }
</script>
</body>
</html>